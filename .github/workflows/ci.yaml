name: CI

on:
  push:
    branches-ignore:
    - 'release/**'
    paths-ignore:
    - '**/*.md'
    #- 'Samples/**'
  pull_request:
    types: [opened, synchronize, reopened] 
    paths-ignore:
    - '**/*.md'
    #- 'Samples/**'

env:
    net_core_version: 6.0.100-rc.1.21414.1

jobs:
  build:

    runs-on: ubuntu-20.04

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1 
      with:
        dotnet-version: ${{ env.net_core_version }}
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Build.App.Cross
      run: dotnet build ./Nivaes.App.Cross/ --configuration Release

    #- name: Test
    #  run: dotnet test --configuration Release --no-build --verbosity normal

  build-Android:
    needs: build
    runs-on: windows-2019
    #runs-on: ubuntu-20.04

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.net_core_version }}
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Install workload
      #shell: pwsh
      run: |
        dotnet workload install android-aot  --include-previews --ignore-failed-sources --verbosity detailed
        #dotnet workload install android-aot  --verbosity detailed

    #- name: Build App.Cross
    #  run: dotnet build ./Nivaes.App.Cross/ --configuration Release

    - name: Build App.Cross.Droid 
      run: dotnet build ./Nivaes.App.Cross.Droid/ --configuration Release

  build-Android-Samples:
    needs: build-Android
    runs-on: windows-2019
    #runs-on: ubuntu-20.04

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.net_core_version }}
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Install workload
      #shell: pwsh
      run: |
        dotnet workload install android-aot  --include-previews --ignore-failed-sources --verbosity detailed
        #dotnet workload install android-aot  --verbosity detailed

    - name: App.Cross.Mobile.Droid.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Mobile.Droid.Sample/ --configuration Release

  build-Tizen:
    needs: build
    runs-on: ubuntu-20.04

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.net_core_version }}
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    #- name: Install Tizzen
    #  #shell: pwsh
    #  run: |
    #    git clone -b release/6.0.1xx-preview7 https://github.com/Samsung/Tizen.NET
    #    cd Tizen.NET/workload
    #    make install DESTDIR=/home/runner/

    #- name: Install workload
    #  #shell: pwsh
    #  run: |
    #    dotnet workload install tizen

    - name: Build App.Cross
      run: dotnet build ./Nivaes.App.Cross/ --configuration Release

    #- name: Build App.Cross.Droid 
    #  run: dotnet build ./Nivaes.App.Cross.Tizen/ --configuration Release

  build-MacOs:
    needs: build
    runs-on: macos-latest

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.net_core_version }}
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Install workload
      shell: pwsh
      run: |
        dotnet workload install ios
        dotnet workload install macos
        dotnet workload install maccatalyst
        dotnet workload install tvos

    - name: Install Xcode
      uses: devbotsxyz/xcode-select@v1

    - name: Install Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    #- name: configure vsmac xcode
    #  run: |
    #    set -x
    #    mkdir -p ~/Library/Preferences/Xamarin
    #    rm -f ~/Library/Preferences/Xamarin/Settings.plist
    #    /usr/libexec/PlistBuddy -c "add :AppleSdkRoot string $(dirname $(dirname $(xcode-select -p)))" ~/Library/Preferences/Xamarin/Settings.plist || true
    #    cat ~/Library/Preferences/Xamarin/Settings.plist || true
   
    #- name: Build App.Cross
    #  run: dotnet build ./Nivaes.App.Cross/ --configuration Release

    #- name: Restore iOS
    #  run: dotnet restore ./Nivaes.App.Cross.iOS/

    - name: Build App.Cross.iOS
      run: |
        dotnet build ./Nivaes.App.Cross.iOS/ --configuration Release --runtime iossimulator-x64
        dotnet build ./Nivaes.App.Cross.iOS/ --configuration Release --runtime iossimulator-x86

    #- name: Restore macCatalyst
    #  run: dotnet restore ./Nivaes.App.Cross.macCatalyst/

    - name: Build App.Cross.macCatalyst  
      run: dotnet build ./Nivaes.App.Cross.macCatalyst/ --configuration Release --runtime maccatalyst-x64

    #- name: Restore macOS
    #  run: dotnet restore ./Nivaes.App.Cross.macOS/

    - name: Build App.Cross.macOS
      run: dotnet build ./Nivaes.App.Cross.macOS/ --configuration Release --runtime osx-x64

    #- name: Restore watchOS
    #  run: dotnet restore ./Nivaes.App.Cross.watchOS/

    #- name: Build App.Cross.watchOS
    #  run: msbuild ./Nivaes.App.Cross.watchOS/ /t:build
    #  #run: dotnet build ./Nivaes.App.Cross.watchOS/ --configuration Release

    - name: Restore tvOS
      run: dotnet restore ./Nivaes.App.Cross.tvOS/ 

    - name: Build App.Cross.tvOS
      run: dotnet build ./Nivaes.App.Cross.tvOS/ --configuration Release --runtime tvossimulator-x64

  build-MacOs-Samples:
    needs: build-MacOs
    runs-on: macos-latest

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.net_core_version }}
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Install workload
      shell: pwsh
      run: |
        dotnet workload install ios
        dotnet workload install macos
        dotnet workload install maccatalyst
        dotnet workload install tvos

    - name: Install Xcode
      uses: devbotsxyz/xcode-select@v1

    - name: Install Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    #- name: Build App.Cross.iOS
    #  run: dotnet build ./Nivaes.App.Cross.iOS/ --configuration Release --runtime iossimulator-x64

    - name: Build App.Cross.Mobile.iOS.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Mobile.iOS.Sample/ --configuration Release --runtime iossimulator-x64

    - name: Build App.Cross.Mobile.Catalyst.Sample
      run: |
        dotnet build ./Nivaes.App.Cross.macCatalyst/ --configuration Release --runtime maccatalyst-x64
        dotnet build ./Samples/Nivaes.App.Cross.Mobile.Catalyst.Sample/ --configuration Release --runtime maccatalyst-x64

    - name: Build App.Cross.Desktop.macOS.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Desktop.macOS.Sample/ --configuration Release --runtime osx-x64

  build-Windows:
    needs: build
    runs-on: windows-2019

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.net_core_version }} 
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Build App.Cross
      run: dotnet build ./Nivaes.App.Cross/ --configuration Release

    #- name: Restore Windows
    #  run: dotnet restore ./Nivaes.App.Cross.Windows/

    #- name: Build Windows
    #  run: dotnet build ./Nivaes.App.Cross.Windows/ --configuration Release

    #- name: Build Wpf
    #  run: dotnet build ./Nivaes.App.Cross.Windows.Wpf/ --configuration Release
